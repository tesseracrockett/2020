<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GBIF And Spatial Data • compbio2020</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="GBIF And Spatial Data">
<meta property="og:description" content="compbio2020">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">compbio2020</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/00_Syllabus_and_Expectations.html">Syllabus</a>
    </li>
    <li>
      <a href="../articles/01_Getting_Started_with_R.html">Starting with R</a>
    </li>
    <li>
      <a href="../articles/02_Starting_with_Data.html">Starting with data</a>
    </li>
    <li>
      <a href="../articles/03_Manipulating_Data.html">Manipulating, analyzing and exporting data with tidyverse</a>
    </li>
    <li>
      <a href="../articles/04-plotting.html">Data visualization with ggplot2</a>
    </li>
    <li>
      <a href="../articles/05-Functions.html">Functions and repeatability</a>
    </li>
    <li>
      <a href="../articles/06_Exploration_Setup.html">Exploration</a>
    </li>
    <li>
      <a href="../articles/07_Exploration_Hands_On.html">Exploration Hands-On</a>
    </li>
    <li>
      <a href="../articles/09_GBIF_and_Location.html">GBIF And Spatial Data</a>
    </li>
    <li>
      <a href="../articles/FunctionReference.html">FunctionReference.Rmd</a>
    </li>
    <li>
      <a href="../articles/HomeworkOne.html">Homework One</a>
    </li>
    <li>
      <a href="../articles/HomeworkThree.html">Homework3</a>
    </li>
    <li>
      <a href="../articles/HomeworkTwo.html">Homework Two</a>
    </li>
    <li>
      <a href="../articles/ProjectOne.html">ProjectOne</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="09_GBIF_and_Location_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>GBIF And Spatial Data</h1>
            
      
      
      <div class="hidden name"><code>09_GBIF_and_Location.Rmd</code></div>

    </div>

    
    
<p>This week, we will be starting with geospatial data and mapping. Today, we will begin with locality data in GBIF. GBIF is a website for aggregating location data from other sources.</p>
<p>We will work with two packages today. One is <a href="https://www.gbif.org/tool/81747/rgbif">RGBIF</a>, an interface to <a href="https://www.gbif.org/">GBIF</a> data maintained by the <a href="https://ropensci.org/">ROpenSci</a> group.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"rgbif"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"leaflet"</span>)</pre></body></html></div>
<p>Later in this lesson, we will also use the <code>rotl</code> package we’ve seen last week.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)</pre></body></html></div>
<pre><code>## ── Attaching packages ─────────────────── tidyverse 1.3.0 ──</code></pre>
<pre><code>## ✓ ggplot2 3.3.2     ✓ purrr   0.3.4
## ✓ tibble  3.0.3     ✓ dplyr   1.0.0
## ✓ tidyr   1.1.0     ✓ stringr 1.4.0
## ✓ readr   1.3.1     ✓ forcats 0.5.0</code></pre>
<pre><code>## ── Conflicts ────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rotl</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">rgbif</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">leaflet</span>)</pre></body></html></div>
<p>First, we’re going to try an example for one ant. We will query locality data and map it in a few ways. Then, you will figure out how to make the process of mapping data iterable over a set of taxa.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/name_suggest.html">name_suggest</a></span>(<span class="st">"Atta mexicana"</span>)</pre></body></html></div>
<pre><code>## Records returned [1] 
## No. unique hierarchies [0] 
## Args [q=Atta mexicana, limit=100, fields1=key, fields2=canonicalName,
##      fields3=rank] 
## # A tibble: 1 x 3
##       key canonicalName rank   
##     &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;  
## 1 5035745 Atta mexicana SPECIES</code></pre>
<p>Next, we’re going to use <code>occ_search</code> to search the GBIF database for where these things are occurring.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"> <span class="no">occurences</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_search.html">occ_search</a></span>(<span class="kw">taxonKey</span> <span class="kw">=</span> <span class="fl">5035745</span>, <span class="kw">limit</span> <span class="kw">=</span> <span class="fl">20</span>)</pre></body></html></div>
<p>Next, we will filter the resultant dataset to name and lat and longitude data.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="no">no_na</span> <span class="kw">&lt;-</span> <span class="no">occurences</span>$<span class="no">data</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">scientificName</span>, <span class="no">decimalLatitude</span>, <span class="no">decimalLongitude</span>) <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>()</pre></body></html></div>
<p>And finally, we will plot the data using <code>leaflet</code></p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">k</span> <span class="kw">&lt;-</span> <span class="kw pkg">leaflet</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>(<span class="no">no_na</span>) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addMarkers</a></span>(~<span class="no">decimalLongitude</span>, ~<span class="no">decimalLatitude</span>, <span class="kw">popup</span> <span class="kw">=</span> <span class="no">no_na</span>$<span class="no">scientificName</span>)</pre></body></html></div>
<p>This looks much like plotting with <code>ggplot</code> and tidyverse. That’s because leaflet is based on the same principles. We establish a canvas and the data in the first line, then we add tiles (the actual map we will use), and then we add our points. When we think about it, this is quite similar to establishing a ggplot canvas, the axes, and the points to plot.</p>
<p>One point is easy. How often do we only want one point, though? Probably, we will want to plot several species. First, with a partner, work out how to get GBIF ids for a set of taxa.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">ants</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Martialis"</span>, <span class="st">"Atta"</span>, <span class="st">"Ectatomma"</span>, <span class="st">"Tatuidris"</span>, <span class="st">"Aneuretus"</span>, <span class="st">"Xymmer"</span>, <span class="st">"Aenictus"</span>)

<span class="co">#Get GBIF ids for our vector of species.</span>


<span class="no">ids</span> <span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>()
  <span class="kw">for</span> (<span class="no">ant</span> <span class="kw">in</span> <span class="no">ants</span>){
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">ant</span>)
   <span class="no">raw</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/name_suggest.html">name_suggest</a></span>(<span class="no">ant</span>)
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">raw</span>)
   <span class="no">ids</span>[<span class="no">ant</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">raw</span>$<span class="no">data</span>$<span class="no">key</span>)
}</pre></body></html></div>
<pre><code>## [1] "Martialis"
## Records returned [72] 
## No. unique hierarchies [0] 
## Args [q=Martialis, limit=100, fields1=key, fields2=canonicalName, fields3=rank] 
## # A tibble: 72 x 3
##        key canonicalName         rank    
##      &lt;int&gt; &lt;chr&gt;                 &lt;chr&gt;   
##  1 7744356 Martialis             GENUS   
##  2 9599316 ? martialis           UNRANKED
##  3 7437085 Martialis heureka     SPECIES 
##  4 5168773 Hahnia martialis      SPECIES 
##  5 1091951 Onthophagus martialis SPECIES 
##  6 5977251 Erynnis martialis     SPECIES 
##  7 4544067 Aculus martialis      SPECIES 
##  8 1275279 Tycherus martialis    SPECIES 
##  9 3869476 Lasiandra martialis   SPECIES 
## 10 5620830 Melocactus martialis  SPECIES 
## # … with 62 more rows</code></pre>
<pre><code>## Warning in ids[ant] &lt;- c(raw$data$key): number of items to replace is not a
## multiple of replacement length</code></pre>
<pre><code>## [1] "Atta"
## Records returned [100] 
## No. unique hierarchies [0] 
## Args [q=Atta, limit=100, fields1=key, fields2=canonicalName, fields3=rank] 
## # A tibble: 100 x 3
##        key canonicalName  rank   
##      &lt;int&gt; &lt;chr&gt;          &lt;chr&gt;  
##  1 1323108 Atta           GENUS  
##  2 6006602 Atta           GENUS  
##  3 5035739 Atta robusta   SPECIES
##  4 5035737 Atta goiana    SPECIES
##  5 8368352 Atta penetrans SPECIES
##  6 5035740 Atta silvae    SPECIES
##  7 5035749 Atta domicola  SPECIES
##  8 8772445 Atta turrifex  SPECIES
##  9 7359300 Atta didita    SPECIES
## 10 5035736 Atta columbica SPECIES
## # … with 90 more rows</code></pre>
<pre><code>## Warning in ids[ant] &lt;- c(raw$data$key): number of items to replace is not a
## multiple of replacement length</code></pre>
<pre><code>## [1] "Ectatomma"
## Records returned [90] 
## No. unique hierarchies [0] 
## Args [q=Ectatomma, limit=100, fields1=key, fields2=canonicalName, fields3=rank] 
## # A tibble: 90 x 3
##        key canonicalName         rank   
##      &lt;int&gt; &lt;chr&gt;                 &lt;chr&gt;  
##  1 1314135 Ectatomma             GENUS  
##  2 7570313 Ectatomma parasiticum SPECIES
##  3 9175376 Ectatomma rimulosum   SPECIES
##  4 4673127 Ectatomma socrus      SPECIES
##  5 1314147 Ectatomma edentatum   SPECIES
##  6 4673125 Ectatomma rothneyi    SPECIES
##  7 1314136 Ectatomma gibbum      SPECIES
##  8 1314144 Ectatomma planidens   SPECIES
##  9 1314149 Ectatomma opaciventre SPECIES
## 10 4673119 Ectatomma punctata    SPECIES
## # … with 80 more rows</code></pre>
<pre><code>## Warning in ids[ant] &lt;- c(raw$data$key): number of items to replace is not a
## multiple of replacement length</code></pre>
<pre><code>## [1] "Tatuidris"
## Records returned [3] 
## No. unique hierarchies [0] 
## Args [q=Tatuidris, limit=100, fields1=key, fields2=canonicalName, fields3=rank] 
## # A tibble: 3 x 3
##       key canonicalName     rank   
##     &lt;int&gt; &lt;chr&gt;             &lt;chr&gt;  
## 1 1319364 Tatuidris         GENUS  
## 2 9541003 Tatuidris kapasi  SPECIES
## 3 1319365 Tatuidris tatusia SPECIES</code></pre>
<pre><code>## Warning in ids[ant] &lt;- c(raw$data$key): number of items to replace is not a
## multiple of replacement length</code></pre>
<pre><code>## [1] "Aneuretus"
## Records returned [4] 
## No. unique hierarchies [0] 
## Args [q=Aneuretus, limit=100, fields1=key, fields2=canonicalName, fields3=rank] 
## # A tibble: 4 x 3
##       key canonicalName     rank   
##     &lt;int&gt; &lt;chr&gt;             &lt;chr&gt;  
## 1 1320037 Aneuretus         GENUS  
## 2 1320038 Aneuretus simoni  SPECIES
## 3 1737071 Decodes aneuretus SPECIES
## 4 1590997 Bibio aneuretus   SPECIES</code></pre>
<pre><code>## Warning in ids[ant] &lt;- c(raw$data$key): number of items to replace is not a
## multiple of replacement length</code></pre>
<pre><code>## [1] "Xymmer"
## Records returned [3] 
## No. unique hierarchies [0] 
## Args [q=Xymmer, limit=100, fields1=key, fields2=canonicalName, fields3=rank] 
## # A tibble: 3 x 3
##        key canonicalName rank   
##      &lt;int&gt; &lt;chr&gt;         &lt;chr&gt;  
## 1  4674293 Xymmer        GENUS  
## 2 10000176 Xymmer ambvky SPECIES
## 3  8741954 Xymmer phungi SPECIES</code></pre>
<pre><code>## Warning in ids[ant] &lt;- c(raw$data$key): number of items to replace is not a
## multiple of replacement length</code></pre>
<pre><code>## [1] "Aenictus"
## Records returned [100] 
## No. unique hierarchies [0] 
## Args [q=Aenictus, limit=100, fields1=key, fields2=canonicalName, fields3=rank] 
## # A tibble: 100 x 3
##        key canonicalName          rank   
##      &lt;int&gt; &lt;chr&gt;                  &lt;chr&gt;  
##  1 1317499 Aenictus               GENUS  
##  2 1317525 Aenictus binghami      SPECIES
##  3 1317542 Aenictus eugenii       SPECIES
##  4 1317621 Aenictus furculatus    SPECIES
##  5 1317629 Aenictus obscurus      SPECIES
##  6 1317535 Aenictus porizonoides  SPECIES
##  7 1317552 Aenictus vagans        SPECIES
##  8 8602349 Aenictus subterraneus  SPECIES
##  9 1317599 Aenictus steindachneri SPECIES
## 10 7485901 Aenictus levior        SPECIES
## # … with 90 more rows</code></pre>
<pre><code>## Warning in ids[ant] &lt;- c(raw$data$key): number of items to replace is not a
## multiple of replacement length</code></pre>
<p>Now, we will get the actual specimen occurrences for these ants. Practice using an apply function to do this. Inspect the object you’ve queried when you’ve completed your loop. Have we dealt with an object like this before?</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">ids</span> <span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>()
  <span class="kw">for</span> (<span class="no">ant</span> <span class="kw">in</span> <span class="no">ants</span>){
   <span class="no">raw</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/name_suggest.html">name_suggest</a></span>(<span class="no">ant</span>)
   <span class="fu"><a href="https://docs.ropensci.org/rgbif/reference/occ_search.html">occ_search</a></span>(<span class="kw">taxonKey</span> <span class="kw">=</span> <span class="no">raw</span>$<span class="no">data</span>$<span class="no">key</span>, <span class="kw">limit</span> <span class="kw">=</span> <span class="fl">10</span>)
}</pre></body></html></div>
<p>This is a vector or dataframes. Each individual query made it’s own dataframe. For simplicity, lets combine them into one dataframe object.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="co">#Combine the resultant dataframes into one large dataframe</span>
<span class="no">mega_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="kw">.id</span> <span class="kw">=</span> <span class="st">"column_label"</span>)
  <span class="kw">for</span> (<span class="no">ant</span> <span class="kw">in</span> <span class="no">ants</span>){
   <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">df</span>$<span class="no">ant</span>$<span class="no">data</span>)
}</pre></body></html></div>
<p>Since we will be plotting these with a map, we need complete data in both columns - lat and long. Let’s drop any columns without data in both.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="co">#Drop rows with NA values in the lat and long</span>
<span class="no">no_na</span> <span class="kw">&lt;-</span> <span class="no">mega_df</span> <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">scientificName</span>, <span class="no">decimalLatitude</span>, <span class="no">decimalLongitude</span>) <span class="kw">%&gt;%</span>
<span class="fu">drop_na</span>()</pre></body></html></div>
<p>Now let’s take a peek at our results!</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="co"># Plot the dataframe of observations</span>
<span class="no">k</span> <span class="kw">&lt;-</span> <span class="kw pkg">leaflet</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>(<span class="no">no_na</span>) <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addMarkers</a></span>(~<span class="no">decimalLongitude</span>, ~<span class="no">decimalLatitude</span>, <span class="kw">popup</span> <span class="kw">=</span> <span class="no">no_na</span>$<span class="no">scientificName</span>)</pre></body></html></div>
<div id="geospatial-choose-your-own-adventure" class="section level1">
<h1 class="hasAnchor">
<a href="#geospatial-choose-your-own-adventure" class="anchor"></a>GeoSpatial Choose Your Own Adventure</h1>
<p>Below are six code snippets to do different types of map-based plotting. With a partner, discuss what you think would be interesting or important to view in these data. Choose a block of code to modify to accomplish your visualization. We will reconvene in about 30 minutes and do a Round Robin showing everyone’s maps. <em>Have Fun!</em></p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>(<span class="no">no_na</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircles</a></span>(~<span class="no">decimalLongitude</span>, ~<span class="no">decimalLatitude</span>)</pre></body></html></div>
<div id="draw-point-sizes-from-a-distribution" class="section level3">
<h3 class="hasAnchor">
<a href="#draw-point-sizes-from-a-distribution" class="anchor"></a>Draw point sizes from a distribution</h3>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>(<span class="no">no_na</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span>(~<span class="no">decimalLongitude</span>, ~<span class="no">decimalLatitude</span>, <span class="kw">radius</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">100</span>, <span class="fl">4</span>, <span class="fl">10</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'red'</span>))</pre></body></html></div>
</div>
<div id="cluster-observations" class="section level3">
<h3 class="hasAnchor">
<a href="#cluster-observations" class="anchor"></a>Cluster observations</h3>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>(<span class="no">no_na</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addMarkers</a></span>(~<span class="no">decimalLongitude</span>, ~<span class="no">decimalLatitude</span>, <span class="kw">clusterOptions</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-options.html">markerClusterOptions</a></span>())</pre></body></html></div>
</div>
<div id="size-points-by-number-of-observations" class="section level3">
<h3 class="hasAnchor">
<a href="#size-points-by-number-of-observations" class="anchor"></a>Size points by number of observations</h3>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">no_na</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">decimalLatitude</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">n_areas</span> <span class="kw">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span>())  <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span>(~<span class="no">decimalLongitude</span>, ~<span class="no">decimalLatitude</span>, <span class="kw">radius</span> <span class="kw">=</span> ~<span class="no">n_areas</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'red'</span>))</pre></body></html></div>
</div>
<div id="color-points-by-species" class="section level3">
<h3 class="hasAnchor">
<a href="#color-points-by-species" class="anchor"></a>Color points by species</h3>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="no">pal</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorBin</a></span>(
  <span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Blues"</span>,
  <span class="no">no_na</span>$<span class="no">scientificName</span>,
  <span class="kw">pretty</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">levs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">no_na</span>$<span class="no">scientificName</span>)
<span class="no">factpal</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorFactor</a></span>(<span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">topo.colors</a></span>(<span class="fl">5</span>), <span class="no">levs</span>)

<span class="no">no_na</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">scientificName</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span>(
    ~<span class="no">decimalLongitude</span>,
    ~<span class="no">decimalLatitude</span>,
    <span class="kw">color</span> <span class="kw">=</span> ~<span class="fu">factpal</span>(<span class="no">scientificName</span>),
    <span class="kw">stroke</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">fillOpacity</span> <span class="kw">=</span> <span class="fl">0.5</span>
  )</pre></body></html></div>
</div>
<div id="set-view-width" class="section level3">
<h3 class="hasAnchor">
<a href="#set-view-width" class="anchor"></a>Set view Width</h3>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="no">pal</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorBin</a></span>(
  <span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Blues"</span>,
  <span class="no">no_na</span>$<span class="no">scientificName</span>,
  <span class="kw">pretty</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">levs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">no_na</span>$<span class="no">scientificName</span>)
<span class="no">factpal</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/colorNumeric.html">colorFactor</a></span>(<span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">topo.colors</a></span>(<span class="fl">5</span>), <span class="no">levs</span>)

<span class="no">no_na</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="no">scientificName</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html">leaflet</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addTiles</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html">addCircleMarkers</a></span>(
    ~<span class="no">decimalLongitude</span>,
    ~<span class="no">decimalLatitude</span>,
    <span class="kw">color</span> <span class="kw">=</span> ~<span class="fu">factpal</span>(<span class="no">scientificName</span>),
    <span class="kw">stroke</span> <span class="kw">=</span> <span class="fl">FALSE</span>, <span class="kw">fillOpacity</span> <span class="kw">=</span> <span class="fl">0.5</span>
  ) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html">setView</a></span>( <span class="kw">lng</span> <span class="kw">=</span> -<span class="fl">100</span>,
            <span class="kw">lat</span> <span class="kw">=</span> <span class="fl">20</span>,
            <span class="kw">zoom</span> <span class="kw">=</span> <span class="fl">11</span> ) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html">setMaxBounds</a></span>( <span class="kw">lng1</span> <span class="kw">=</span> -<span class="fl">100</span>,
                <span class="kw">lat1</span> <span class="kw">=</span> <span class="fl">19.432241</span>,
                <span class="kw">lng2</span> <span class="kw">=</span> -<span class="fl">98</span>,
                <span class="kw">lat2</span> <span class="kw">=</span> <span class="fl">20</span> )</pre></body></html></div>
</div>
<div id="extra-map-color-options-base-maps" class="section level3">
<h3 class="hasAnchor">
<a href="#extra-map-color-options-base-maps" class="anchor"></a>Extra map color options (base maps)</h3>
<p><a href="https://rstudio.github.io/leaflet/basemaps.html" class="uri">https://rstudio.github.io/leaflet/basemaps.html</a></p>
</div>
<div id="mapping-a-tree-to-space" class="section level2">
<h2 class="hasAnchor">
<a href="#mapping-a-tree-to-space" class="anchor"></a>Mapping a tree to space</h2>
<p>We will need one package we haven’t used yet, Liam Revell’s Phytools.</p>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"liamrevell/phytools"</span>)</pre></body></html></div>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">phytools</span>)</pre></body></html></div>
<pre><code>## Loading required package: ape</code></pre>
<pre><code>## Loading required package: maps</code></pre>
<pre><code>## 
## Attaching package: 'maps'</code></pre>
<pre><code>## The following object is masked from 'package:purrr':
## 
##     map</code></pre>
<p>Plotting a phylogeny to a map is a fairly simple task, but has a lot of data preparation work involved. The basic steps look like this:</p>
<ol style="list-style-type: decimal">
<li>Synchronize names between GBIF and OpenTree</li>
<li>Format GBIF data into a matrix</li>
<li>Add branch lengths to our tree</li>
<li>Plot</li>
</ol>
<p>You may have noticed that the GBIF package includes citation information in the scientificName column. We will need to remove that. To do this, let’s try the <code>strsplit</code> function. This function splits a character string on a defined character and returns a vector of the elements in that character string.</p>
<p>For example:</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="no">my_string</span> <span class="kw">=</span> <span class="st">"This is my string"</span>
<span class="no">split_up</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">my_string</span>, <span class="st">" "</span>)
<span class="no">split_up</span></pre></body></html></div>
<pre><code>## [[1]]
## [1] "This"   "is"     "my"     "string"</code></pre>
<p>Try indexing this object. What do you need to do to access data? Now, with a partner, make this iterable across every row in the <code>scientificName</code> column. Then, unite the split objects into one new column called <code>genusSpecies</code>.</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="no">split_names</span> <span class="kw">&lt;-</span> <span class="no">no_na</span> <span class="kw">%&gt;%</span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">genus</span> <span class="kw">=</span> <span class="fu">map_chr</span>(<span class="no">scientificName</span>, <span class="kw">function</span>(<span class="no">s</span>) <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">s</span>, <span class="st">" "</span>)<span class="kw">[[</span><span class="fl">1</span>]][<span class="fl">1</span>]))<span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">species</span> <span class="kw">=</span> <span class="fu">map_chr</span>(<span class="no">scientificName</span>, <span class="kw">function</span>(<span class="no">s</span>) <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="no">s</span>, <span class="st">" "</span>)<span class="kw">[[</span><span class="fl">1</span>]][<span class="fl">2</span>])) <span class="kw">%&gt;%</span>
<span class="fu">unite</span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">genusSpecies</span>, <span class="no">genus</span>, <span class="no">species</span>)</pre></body></html></div>
<p>If you look at the data, there are some obviously mistaken values in there. For example, BOLD is not an ant species. Let’s drop that.</p>
<div class="sourceCode" id="cb46"><html><body><pre class="r"><span class="co"># Use ROTL to resolve names</span>

<span class="no">no_bold</span> <span class="kw">&lt;-</span> <span class="no">split_names</span>[ <span class="fu"><a href="https://rdrr.io/r/base/grep.html">grep</a></span>(<span class="st">"BOLD"</span>, <span class="no">split_names</span>$<span class="no">genusSpecies</span>, <span class="kw">invert</span> <span class="kw">=</span> <span class="fl">TRUE</span>) , ]</pre></body></html></div>
<p>We also ended up with far more ant taxa than I thought. What a nice problem to have! But let’s filter down to, say, five of them:</p>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="no">a_couple_ants</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Martialis_heureka"</span>, <span class="st">"Atta_mexicana"</span>, <span class="st">"Atta_cephalotes"</span>, <span class="st">"Atta_sexdens"</span>, <span class="st">"Atta_Fabricius"</span>)
<span class="no">subset_data</span> <span class="kw">&lt;-</span> <span class="no">no_bold</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">genusSpecies</span> <span class="kw">%in%</span> <span class="no">a_couple_ants</span>)</pre></body></html></div>
<p>Now, let’s use ROTL to make sure we don’t have spelling errors.</p>
<div class="sourceCode" id="cb48"><html><body><pre class="r"><span class="no">reconciled_names</span> <span class="kw">&lt;-</span> <span class="kw pkg">rotl</span><span class="kw ns">::</span><span class="fu"><a href="https://docs.ropensci.org/rotl/reference/tnrs_match_names.html">tnrs_match_names</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">subset_data</span>$<span class="no">genusSpecies</span>))
<span class="no">good_names</span> <span class="kw">&lt;-</span>  <span class="no">reconciled_names</span> <span class="kw">%&gt;%</span>
  <span class="fu">drop_na</span>()</pre></body></html></div>
<p>Now, we will query our tree from OpenTree.</p>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="no">tree</span> <span class="kw">&lt;-</span> <span class="kw pkg">rotl</span><span class="kw ns">::</span><span class="fu"><a href="https://docs.ropensci.org/rotl/reference/tol_induced_subtree.html">tol_induced_subtree</a></span>(<span class="no">good_names</span>$<span class="no">ott_id</span>, <span class="kw">label</span><span class="kw">=</span><span class="st">"name"</span>)</pre></body></html></div>
<p>Now, we must combine our GBIF data and our taxon names into a matrix, a two-dimensional data structure with fewer neat data parsing features than a dataframe or tibble. These structures are often preferred when speed is an issue. Matrices can only be one type, which means we must add the row names after generating the object.</p>
<p>And the big reveal! Let’s overlay our OpenTree with our map:</p>
<div class="sourceCode" id="cb50"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">viridis</span>)
<span class="no">cols</span><span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/viridis/man/reexports.html">viridis</a></span>(<span class="kw">n</span><span class="kw">=</span><span class="fu">Ntip</span>(<span class="no">tree</span>))),
    <span class="no">tree</span>$<span class="no">tip.label</span>)

<span class="no">obj</span><span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phylo.to.map.html">phylo.to.map</a></span>(<span class="no">tree</span>,<span class="no">only_lat_long</span>, <span class="kw">plot</span><span class="kw">=</span><span class="fl">FALSE</span>, <span class="kw">direction</span><span class="kw">=</span><span class="st">"rightwards"</span>)</pre></body></html></div>
<p>Oh no! What has gone wrong?</p>
<p>This tree has several quirks. Have a look at the object and see if you can spot them.</p>
<pre><code>
#Answer here

- No branch lengths
- Not fully bifurcating
</code></pre>
<p>First, let’s resolve the polytomy issue. We will do this using Ape’s <code>multi2di</code> function, which arbitrarily resolves polytomies. In real life, you would probably want to think about this a little more.:</p>
<p>We’ll also need to add some branch lengths. In our case, we will draw them from an exponential distribution. The exponential is often assumed to be a reasonable approximation for banch lengths - you’ll hear more about this if you take my systematics lab ;)</p>
<p>In our case, we will use <code>rexp</code> to make the draws, and we will map them to a new attribute <code>edge.length</code> that is a standard attribute of the tree object. In reality, you would likely not want to do this for a publication quality analysis, and would want to estimate branch lengths from data. But being able to rescale branch lengths is a good skill for sensitivity and other similar analyses.</p>
<div class="sourceCode" id="cb52"><html><body><pre class="r"><span class="no">tree</span>$<span class="no">edge.length</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span>(<span class="no">tree</span>$<span class="no">Nnode</span>*<span class="fl">2</span>)
<span class="no">tree</span>$<span class="no">edge.length</span></pre></body></html></div>
<p>Now let’s try that map again.</p>
<div class="sourceCode" id="cb53"><html><body><pre class="r"><span class="no">plot_object</span><span class="kw">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/phytools/man/phylo.to.map.html">phylo.to.map</a></span>(<span class="no">tree</span>,<span class="no">only_lat_long</span>, <span class="kw">plot</span><span class="kw">=</span><span class="fl">FALSE</span>, <span class="kw">direction</span><span class="kw">=</span><span class="st">"rightwards"</span>)</pre></body></html></div>
<p>Finally, we will actually plot to space.</p>
<div class="sourceCode" id="cb54"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">plot_object</span>,<span class="kw">direction</span><span class="kw">=</span><span class="st">"rightwards"</span>,<span class="kw">colors</span><span class="kw">=</span><span class="no">cols</span>,<span class="kw">cex.points</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>),
    <span class="kw">lwd</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">3</span>,<span class="fl">1</span>),<span class="kw">ftype</span><span class="kw">=</span><span class="st">"i"</span>)</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by April Wright.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
